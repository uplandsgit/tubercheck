<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analysis Verdict - TuberCheck</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <h1>üîç Analysis Complete</h1>
        <hr>

        <section class="ai-verdict">
            
            <!-- Use Jinja to split the single result string into two parts based on the separator added in app.py -->
            {% set parts = result.split('---SEPARATOR---') %}
            {% set verdict_line = parts[0] if parts|length > 0 else 'Error: Verdict Missing' %}
            {% set explanation_text = parts[1] if parts|length > 1 else 'No analysis data found in session. This can happen if you navigate directly or if the session timed out. Please go back and upload an image.' %}
            
            {# Determine the class based on the verdict text #}
            {% set verdict_class = 'verdict-error' %}
            {% if 'Gall Disease Present' in verdict_line %}
                {% set verdict_class = 'verdict-present' %}
            {% elif 'Gall Disease Not Present' in verdict_line %}
                {% set verdict_class = 'verdict-not-present' %}
            {% endif %}

            <!-- SECTION 1: IMAGE STATUS - ONLY SHOW MESSAGE IF ANALYSIS FAILED (verdict_class == 'verdict-error') -->
            <div class="analyzed-image-container">
                <h3>Image Submitted for Analysis</h3>
                
                {% if verdict_class == 'verdict-error' %}
                    <!-- Show error message if the analysis itself failed. -->
                    <p class="recommendation-note error-message">
                        The AI analysis failed to run or returned an error. Please check the Detailed Findings section for specific error details.
                    </p>
                {% else %}
                    <!-- If analysis succeeded, simply inform the user the image was processed without displaying the stability disclaimer. -->
                    <p class="disclaimer">
                        Image submitted successfully and processed by AI.
                    </p>
                {% endif %}
            </div>
            <hr>


            {# Wrap the CONFIDENCE part in a class for styling (black color) #}
            {% set wrapped_verdict = verdict_line | replace('[CONFIDENCE:', '<span class="confidence-score">[CONFIDENCE:') | replace('%]', '%]</span>') %}

            <!-- VERDICT DISPLAY (Prominent Box at the top) -->
            <div class="verdict-box">
                <h2>Diagnostic Verdict</h2>
                
                {# Apply the dynamic class to the paragraph tag to change the status color #}
                <p class="{{ verdict_class }}">
                    {{ wrapped_verdict | safe }}
                </p>
            </div>

            <!-- DETAILED EXPLANATION SECTION -->
            <h2>Detailed Findings & Analysis</h2>
            <p>The AI performed a visual inspection. Please check the confidence score and the findings below carefully.</p>
            
            <!-- Explanation Text (cleaned and formatted in app.py) -->
            <div class="ai-output">{{ explanation_text | safe }}</div>

            <p class="recommendation-note">
                If the verdict is 'Gall Present' or the confidence is low (below 70%), proceed with caution and a physical inspection.
            </p>
        </section>

        <hr>

        <section class="reference-guide">
            <h2>üí° Human-Assisted Visual Guide</h2>
            <p>Compare the questionable areas on your tuber with this reference image showing definitive crown gall symptoms.</p>
            
            <div class="image-comparison">
                <img src="{{ url_for('static', filename='images/gall_reference.jpg') }}" 
                     alt="Reference image showing definitive crown gall on a dahlia tuber" 
                     class="reference-image">
            </div>

            <p class="disclaimer">
                Crown Gall appears as rough, woody, irregular tumors, usually near the crown (where the stem meets the tuber).
            </p>
        </section>

        <a href="/" class="button secondary-button">Analyze Another Tuber</a>
    </div>
</body>
</html>